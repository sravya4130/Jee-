// Global Variables
let selectedSubject = '';
let selectedTutor = '';
let selectedTopic = '';
let tutors = JSON.parse(localStorage.getItem('tutors')) || ['Alex', 'David', 'Sravya', 'Olivia', 'Mermi', 'Ogneson'];
let score = 0;
let timerInterval;
let timeLeft = 300; // Default 5 minutes
let gameMode = 'type'; // 'type' or 'draw'

// Sample Data for Modularity
const subjects = {
    chemistry: {
        topics: {
            hybridisation: 'Content for Hybridisation...',
            'sigma-pi': 'Content for Sigma & Pi bonds...',
            iupac: {
                teaching: 'IUPAC rules: 1. Identify the longest chain. 2. Number carbons. Examples: Methane (CH4) is methane. Ethane (C2H6) is ethane.',
                examples: [
                    { structure: 'CH4', name: 'methane' },
                    { structure: 'C2H6', name: 'ethane' },
                    { structure: 'C3H8', name: 'propane' }
                ]
            }
        }
    }
};

// Sidebar Toggle
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

// Screen Navigation
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    toggleSidebar();
}

// Subject Selection
function selectSubject(subject) {
    selectedSubject = subject;
    showScreen('tutor-selection');
    loadTutors();
}

// Tutor Selection
function loadTutors() {
    const list = document.getElementById('tutor-list');
    list.innerHTML = '';
    tutors.forEach(tutor => {
        const btn = document.createElement('button');
        btn.className = 'tutor-btn';
        btn.textContent = tutor;
        btn.onclick = () => { selectedTutor = tutor; };
        list.appendChild(btn);
    });
}

// Topic Selection
function selectTopic(topic) {
    selectedTopic = topic;
    if (topic === 'iupac') {
        showScreen('iupac-teach');
        loadIUPACTeach();
    } else {
        alert('Topic not fully implemented yet.');
    }
}

// IUPAC Teaching
function loadIUPACTeach() {
    document.getElementById('tutor-display').textContent = `Tutor: ${selectedTutor}`;
    document.getElementById('teaching-content').textContent = subjects.chemistry.topics.iupac.teaching;
    alert('Audio: [Simulated teaching voice]');
}

// IUPAC Game
function startIUPACGame() {
    showScreen('iupac-game');
    score = 0;
    timeLeft = parseInt(prompt('Set timer (seconds, 60-300):', 300)) || 300;
    gameMode = prompt('Mode: type or draw?', 'type');
    document.getElementById('score').textContent = score;
    startTimer();
    loadGameQuestion();
}

function loadGameQuestion() {
    const content = document.getElementById('game-content');
    const example = subjects.chemistry.topics.iupac.examples[Math.floor(Math.random() * 3)];
    if (gameMode === 'type') {
        content.innerHTML = `<p>Structure: ${example.structure}</p><input id="answer" placeholder="Type IUPAC name"><button onclick="checkAnswer('${example.name}')">Submit</button>`;
    } else {
        content.innerHTML = `<p>Name: ${example.name}</p><canvas id="sketch" width="300" height="200"></canvas><button onclick="checkDrawing('${example.structure}')">Submit Drawing</button>`;
        initCanvas();
    }
}

function checkAnswer(correct) {
    const answer = document.getElementById('answer').value.toLowerCase();
    if (answer === correct) {
        score += 10;
        alert('Correct!');
    } else {
        alert('Wrong!');
    }
    document.getElementById('score').textContent = score;
    loadGameQuestion();
}

function checkDrawing(correct) {
    // Simple check: Assume correct if canvas has content (enhance later)
    if (confirm('Is your drawing correct?')) {
        score += 10;
    }
    document.getElementById('score').textContent = score;
    loadGameQuestion();
}

function initCanvas() {
    const canvas = document.getElementById('sketch');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mousemove', (e) => {
        if (drawing) {
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
    });
}

function startTimer() {
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('time-left').textContent = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert('Time up! Final Score: ' + score);
        }
    }, 1000);
}

function hint() {
    alert('Hint: Check the longest chain.');
}

function retry() {
    clearInterval(timerInterval);
    startIUPACGame();
}

// Settings: Edit Tutors
function loadSettings() {
    const list = document.getElementById('tutor-edit-list');
    list.innerHTML = '';
    tutors.forEach((tutor, index) => {
        const input = document.createElement('input');
        input.value = tutor;
        input.id = `tutor-${index}`;
        list.appendChild(input);
    });
}

function saveTutorNames() {
    tutors = tutors.map((_, index) => document.getElementById(`tutor-${index}`).value);
    localStorage.setItem('tutors', JSON.stringify(tutors));
    alert('Saved!');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadSettings(); // For settings screen
});
